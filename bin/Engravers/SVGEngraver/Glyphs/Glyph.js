"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Glyphs_1 = require("Engravers/SVGEngraver/Glyphs");
const SMuFL = require("Schema/SMuFL");
class Glyph extends Glyphs_1.SVG {
    // INSTANCE
    constructor(type, id, headPosition = { x: 0, y: 0 }) {
        super('svg');
        this.headPosition = headPosition;
        // DRAW
        this.draw = () => {
            // has to keep strange syntax to get correct this.draw()
            // there are no other way to automatically call the right draw()
            // keeping explicit draw() calls make code more readable
            // so do not refactor
            if (this.id) {
                this.addClass(`id-${this.id}`);
                Glyph.refs[this.id] = this;
            }
            if (this.type) {
                this.addClass(this.type ? this.type : this.constructor.name);
            }
        };
        // checkType
        if (type !== undefined) {
            this.type = type;
        }
        else {
            this.type = this.constructor.name.match(/([a-z]+|[A-Z][a-z]+)/g)
                .splice(0, -1) // remove "glyph"
                .join('-')
                .toLowerCase();
        }
        if (id !== undefined) {
            this.id = id;
        }
        this.draw();
    }
    // GLYPH OPS
    // here is a huge catch, using super.width would trigger this.bbox
    // which instead of pointing to SVG.bbox, it uses child class bbox
    // and leads to double conversion of units, this is extremely
    // confusing, and no need to override width and height as they
    // rely only on bbox, override bbox solves the whole problem
    advance(childGlyph, x) {
        this.headPosition.x += x;
        childGlyph.move(this.headPosition.x);
    }
    shift(y) {
        this.move(undefined, -y);
    }
    shiftInterval(interval) {
        this.move(undefined, -(interval - 1) / 2); // interval starts with unison (1)
    }
    shiftFromStaffBottom(y) {
        this.move(undefined, 4 - y); // 4 = line 1, 3 = line 2, etc.
    }
    // OVERRIDE WITH NEW UNITS
    move(x, y) {
        super.move(x ? x * Glyph.STAFF_SPACE : undefined, y ? y * Glyph.STAFF_SPACE : undefined);
        return this;
    }
    rotate(angle, cx, cy) {
        cx = cx !== undefined ? cx : 0;
        cy = cy !== undefined ? cy : 0;
        super.rotate(angle, cx * Glyph.STAFF_SPACE, cy * Glyph.STAFF_SPACE);
        return this;
    }
    size(width, height) {
        super.size(width ? width * Glyph.STAFF_SPACE : undefined, height ? height * Glyph.STAFF_SPACE : undefined);
        return this;
    }
    overlapsWith(targetGlyph) {
        return (this.bbox.x < (targetGlyph.bbox.x + targetGlyph.width) &&
            targetGlyph.bbox.x < (this.bbox.x + this.bbox.width) &&
            this.bbox.y < (targetGlyph.bbox.y + targetGlyph.height) &&
            targetGlyph.bbox.y < (this.bbox.y + this.height));
    }
    get width() {
        return super.width / Glyph.STAFF_SPACE;
    }
    set width(width) {
        super.width = width * Glyph.STAFF_SPACE;
    }
    get height() {
        return super.height / Glyph.STAFF_SPACE;
    }
    set height(height) {
        super.height = height * Glyph.STAFF_SPACE;
    }
    get bbox() {
        let bbox = super.bbox;
        return {
            x: bbox.x / Glyph.STAFF_SPACE,
            y: bbox.y / Glyph.STAFF_SPACE,
            width: bbox.width / Glyph.STAFF_SPACE,
            height: bbox.height / Glyph.STAFF_SPACE
        };
    }
}
// STATIC
Glyph.EM = 32;
Glyph.STAFF_SPACE = Glyph.EM * 0.25;
Glyph.meta = SMuFL.Meta.load();
Glyph.refs = {};
exports.Glyph = Glyph;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR2x5cGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvRW5ncmF2ZXJzL1NWR0VuZ3JhdmVyL0dseXBocy9HbHlwaC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlEQUFtRDtBQUVuRCxzQ0FBc0M7QUFFdEMsV0FBbUIsU0FBUSxZQUFHO0lBVTFCLFdBQVc7SUFFWCxZQUFZLElBQWEsRUFDYixFQUFXLEVBQ0gsZUFBd0MsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUU7UUFDdEUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBREcsaUJBQVksR0FBWixZQUFZLENBQTBDO1FBcUIxRSxPQUFPO1FBRUcsU0FBSSxHQUFHLEdBQVMsRUFBRTtZQUN4Qix3REFBd0Q7WUFDeEQsZ0VBQWdFO1lBQ2hFLHdEQUF3RDtZQUN4RCxxQkFBcUI7WUFFckIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ1YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUUvQixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDL0IsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNaLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNqRSxDQUFDO1FBRUwsQ0FBQyxDQUFDO1FBcENFLFlBQVk7UUFFWixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUNyQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUks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